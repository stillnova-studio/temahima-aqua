<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1a3c6b">
<title>„Å¶„Åæ„Å≤„Åæ„Ç¢„ÇØ„Ç¢</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='80' font-size='80'>üêü</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='80' font-size='80'>üêü</text></svg>">
<meta name="apple-mobile-web-app-title" content="„Å¶„Åæ„Å≤„Åæ„Ç¢„ÇØ„Ç¢">
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700;800&display=swap');
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{font-family:'Noto Sans JP',sans-serif;background:#f0f4f8;color:#1b2d44;font-size:15px}
button{cursor:pointer;border:none;background:none;font-family:inherit;font-size:inherit;color:inherit}
button:active:not(:disabled){transform:scale(0.97)}
button:disabled{opacity:.4;cursor:default}
input,textarea,select{font-family:inherit;font-size:inherit;color:#1b2d44}
input:focus,textarea:focus{outline:3px solid #3a8fd4;outline-offset:-1px}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:#a0b8cc;border-radius:5px}
#app{max-width:520px;margin:0 auto;height:100vh;height:100dvh;display:flex;flex-direction:column;background:#f0f4f8;position:relative;overflow:hidden}
.hd{background:linear-gradient(135deg,#1a3c6b,#2870a8);padding:14px 18px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 3px 18px rgba(26,60,107,.3);z-index:10;padding-top:max(14px,env(safe-area-inset-top));min-height:54px}
.hd-main{display:flex;align-items:center;gap:10px;cursor:pointer}
.hd h1{color:#fff;font-size:22px;font-weight:800;letter-spacing:.5px}
.hd .back{display:flex;align-items:center;gap:8px;color:#fff;font-size:16px;font-weight:600}
.hd .loc{font-size:15px;font-weight:700;opacity:.9;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.toast{position:fixed;top:70px;left:50%;transform:translateX(-50%);background:#1b2d44;color:#fff;padding:8px 20px;border-radius:20px;font-size:14px;font-weight:600;z-index:200;box-shadow:0 4px 16px rgba(0,0,0,.15);animation:ta 2s forwards;white-space:nowrap;pointer-events:none}
@keyframes ta{0%{opacity:0;transform:translateX(-50%) translateY(-10px)}10%{opacity:1;transform:translateX(-50%) translateY(0)}80%{opacity:1}100%{opacity:0}}
.mn{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch}
.ct{padding:16px 16px 30px}
.nv{display:flex;justify-content:space-around;background:#fff;border-top:1px solid #d0dbe5;padding:8px 0;padding-bottom:max(16px,env(safe-area-inset-bottom));z-index:10}
.nv button{display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 22px;font-size:11px;color:#8a9aaa;transition:color .2s}
.nv button.on{color:#1a3c6b;font-weight:700}
.cd{background:#fff;border-radius:16px;margin-bottom:14px;box-shadow:0 2px 12px rgba(26,60,107,.06);border:1.5px solid #d0dbe5;overflow:hidden}
.cd-h{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;cursor:pointer;background:linear-gradient(to right,#eef2f7,#e5ecf3)}
.gt{font-weight:800;font-size:17px}.cnt{background:#c0d4e8;color:#1a3c6b;border-radius:12px;padding:2px 10px;font-size:13px;font-weight:800;margin-left:6px}
.cd-b{padding:8px 16px 14px}
.dbtn{font-size:13px;font-weight:700;color:#2870a8;padding:6px 12px;border-radius:8px;background:#e5f0fa;border:1.5px solid #b5cce0}
.gbtn{font-size:13px;font-weight:700;color:#fff;padding:6px 12px;border-radius:8px;background:linear-gradient(135deg,#1a3c6b,#2870a8);margin-left:6px}
.pc{display:flex;align-items:center;width:100%;padding:14px 12px;background:#f6f9fc;border-radius:12px;margin-bottom:6px;border:1.5px solid #dce4ec;text-align:left}
.pn{font-weight:700;font-size:16px}.ps{font-size:13px;color:#6b7f8e;margin-top:3px;display:flex;align-items:center;gap:6px}
.ar{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap}
.ab{flex:1;display:flex;flex-direction:column;align-items:center;gap:6px;padding:16px 8px;border-radius:14px;border:2px solid #d0dbe5;background:#f6f9fc;font-size:14px;font-weight:600;min-width:80px}
.ab.dg{border-color:#e8c0c0}
.dh{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:12px;flex-wrap:wrap}
.vt{font-size:20px;font-weight:800}
.ec{display:flex;align-items:center;gap:5px;font-size:14px;font-weight:600;color:#2870a8;padding:6px 14px;border-radius:10px;background:#e5f0fa;border:1.5px solid #b5cce0;white-space:nowrap}
.gl{display:inline-block;padding:4px 12px;border-radius:8px;background:#e5ecf3;font-size:13px;font-weight:600;color:#2e5f8a;margin-bottom:8px}
.sl{font-size:14px;font-weight:800;color:#3a6e99;margin-bottom:8px;margin-top:4px}
.bg{background:linear-gradient(135deg,#1a3c6b,#2870a8);color:#fff;padding:13px 26px;border-radius:14px;font-size:16px;font-weight:700;display:inline-flex;align-items:center;gap:8px;box-shadow:0 3px 14px rgba(26,60,107,.25)}
.bo{background:#fff;color:#1a3c6b;border:2px solid #b5cce0;padding:13px 26px;border-radius:14px;font-size:16px;font-weight:600;display:inline-flex;align-items:center;gap:8px}
.bo.dg{color:#c55;border-color:#e8c0c0}
.bgs{background:linear-gradient(135deg,#1a3c6b,#2870a8);color:#fff;padding:8px 20px;border-radius:10px;font-size:14px;font-weight:700}
.bos{background:#fff;color:#4a6e8a;border:1.5px solid #b5cce0;padding:8px 20px;border-radius:10px;font-size:14px}
.ai{display:flex;align-items:center;gap:6px;color:#2870a8;font-size:15px;font-weight:700;padding:12px 0}
.ch{display:inline-flex;align-items:center;gap:4px;font-size:13px;font-weight:600;color:#2e5f8a;padding:6px 12px;border-radius:8px;background:#eef2f7;border:1.5px solid #c5d4e0}
.ch.dg{color:#c55;border-color:#e8c0c0}
.cg{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.cb{display:flex;flex-direction:column;align-items:center;gap:6px;padding:14px 8px;border-radius:14px;border:2px solid #d0dbe5;background:#f6f9fc;transition:all .2s}
.cb.on{background:#d0e4f5;border-color:#2870a8;box-shadow:inset 0 0 0 2px #2870a8}
.tg{background:#e0ecf5;border-radius:10px;padding:4px 10px;font-size:13px;color:#1a3c6b;font-weight:600;white-space:nowrap;display:inline-block}
.rr{display:flex;align-items:center;width:100%;padding:14px;background:#fff;border-radius:14px;margin-bottom:8px;border:1.5px solid #d0dbe5;text-align:left;box-shadow:0 1px 6px rgba(26,60,107,.05)}
.rn{margin-top:6px;font-size:13px;color:#4a6078;background:#f0f4f8;border-radius:8px;padding:6px 10px;line-height:1.5}
.dthd{display:flex;align-items:center;gap:8px;font-size:15px;font-weight:800;color:#3a6e99;padding:14px 0 8px;border-bottom:2px solid #d0dbe5;margin-bottom:10px}
.sc{background:#fff;border-radius:16px;padding:18px;margin-bottom:14px;border:1.5px solid #d0dbe5}
.sc .st{font-size:17px;font-weight:800;margin-bottom:4px}
.sc .sd{font-size:13px;color:#6b7f8e;margin-bottom:14px;line-height:1.6}
.tr{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #eef2f5;gap:8px}
.tl{font-size:16px;font-weight:600}
.tg2{width:48px;height:28px;border-radius:14px;background:#d0d8dd;position:relative;transition:background .2s;cursor:pointer;flex-shrink:0}
.tg2.on{background:#2870a8}
.tg2 .kn{width:22px;height:22px;border-radius:11px;background:#fff;position:absolute;top:3px;left:3px;transition:transform .2s;box-shadow:0 1px 4px rgba(0,0,0,.15)}
.tg2.on .kn{transform:translateX(20px)}
.mb{padding:16px 18px;border-radius:14px;border:2px solid #c5d4e0;background:#f6f9fc;text-align:left;font-size:16px;display:flex;justify-content:space-between;align-items:center;width:100%;margin-bottom:8px}
.mb.cur{background:#d0e4f5;border-color:#2870a8}
.clbl{font-size:12px;font-weight:700;color:#2870a8;background:#e5f0fa;padding:3px 10px;border-radius:8px}
.ov{position:fixed;inset:0;background:rgba(20,35,55,.5);backdrop-filter:blur(5px);display:flex;align-items:flex-end;justify-content:center;z-index:100;padding:16px}
.md{background:#fff;border-radius:22px;padding:28px 22px 22px;width:100%;max-width:460px;max-height:80vh;overflow-y:auto;box-shadow:0 12px 50px rgba(20,35,55,.25);position:relative}
.md .mx{position:absolute;top:14px;right:14px;padding:6px;border-radius:10px;color:#7a8e9e;background:#eef2f7;font-size:18px}
.md .mt{font-size:19px;font-weight:800;margin-bottom:18px;padding-right:36px}
.inp{width:100%;padding:12px 14px;border-radius:12px;border:2px solid #c5d4e0;font-size:16px;background:#f6f9fc;margin-bottom:8px}
.ta{width:100%;padding:12px 14px;border-radius:12px;border:2px solid #c5d4e0;font-size:15px;background:#f6f9fc;resize:vertical}
.sel{flex:1;min-width:0;padding:10px 12px;border-radius:10px;border:1.5px solid #c5d4e0;font-size:14px;background:#f6f9fc;-webkit-appearance:none}
.fbar{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap}
.ob{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:#eef2f7;border:1.5px solid #c5d4e0;font-size:16px;flex-shrink:0}
.muted{font-size:14px;color:#7a8e9e}.empty{text-align:center;padding:60px 20px}
.rc{display:flex;align-items:center;gap:10px}.fw{display:flex;flex-wrap:wrap;gap:5px;margin-top:4px}
.emi{width:52px;padding:10px;border-radius:12px;border:2px solid #c5d4e0;font-size:22px;text-align:center;background:#f6f9fc}
.sortrow{display:flex;align-items:center;padding:10px 0;border-bottom:1px solid #eef2f5;gap:8px}
.sortbtns{display:flex;gap:4px}
.bk-step{display:flex;gap:12px;align-items:flex-start;margin-bottom:14px;padding:12px;background:#f6f9fc;border-radius:12px;border:1px solid #d0dbe5}
.bk-num{width:28px;height:28px;border-radius:14px;background:#2870a8;color:#fff;font-size:14px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.bk-txt{font-size:14px;line-height:1.5;flex:1}
.diag{background:#f6f9fc;border-radius:12px;padding:14px;border:1px solid #d0dbe5;margin-top:14px}
.diag-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #eef2f5;font-size:13px}
.diag-row:last-child{border-bottom:none}.diag-k{color:#6b7f8e;font-weight:600}.diag-v{font-weight:700}
.ob-wrap{position:fixed;inset:0;background:rgba(20,35,55,.7);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;z-index:300;padding:20px}
.ob-card{background:#fff;border-radius:24px;padding:32px 24px 24px;width:100%;max-width:380px;text-align:center;box-shadow:0 16px 60px rgba(20,35,55,.3)}
.ob-icon{font-size:56px;margin-bottom:16px}.ob-title{font-size:20px;font-weight:800;margin-bottom:10px;color:#1b2d44}
.ob-desc{font-size:15px;color:#5a7088;line-height:1.7;margin-bottom:24px}
.ob-dots{display:flex;justify-content:center;gap:8px;margin-bottom:20px}
.ob-dot{width:10px;height:10px;border-radius:5px;background:#d0d8dd;transition:background .2s}.ob-dot.on{background:#2870a8}
.ob-next{background:linear-gradient(135deg,#1a3c6b,#2870a8);color:#fff;padding:14px 40px;border-radius:16px;font-size:16px;font-weight:700;box-shadow:0 3px 14px rgba(26,60,107,.25)}
.file-hidden{position:absolute;width:1px;height:1px;overflow:hidden;opacity:0}
.empty-care{font-size:14px;color:#7a8e9e;font-style:italic}
.val-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.val-row .inp{flex:1;margin-bottom:0}
.inp-sm{width:80px;padding:10px;font-size:14px;text-align:right;border-radius:10px;border:2px solid #c5d4e0;background:#f6f9fc}
.val-tag{display:inline-flex;align-items:center;gap:4px;font-size:13px;font-weight:600;color:#1a3c6b;background:#d0e4f5;border-radius:8px;padding:4px 10px;margin-right:4px;margin-bottom:4px}
.bio-meta{font-size:13px;color:#6b7f8e;display:flex;gap:8px;flex-wrap:wrap;margin-top:2px}
</style>
</head>
<body>
<div id="app"></div>
<script>
var APP_VERSION="1.0.0";var SCHEMA_VERSION=1;var STORAGE_KEY="aquacare";var DB_NAME="temahima-aqua";var DB_STORE="appstate";var DB_VERSION=1;

var PRESETS=[
{id:"feeding",icon:"\u{1F365}",name:"\u990C\u3084\u308A"},
{id:"waterchange",icon:"\u{1F4A7}",name:"\u6C34\u63DB\u3048"},
{id:"filter",icon:"\u{1F9F9}",name:"\u30D5\u30A3\u30EB\u30BF\u30FC\u6383\u9664"},
{id:"watertest",icon:"\u{1F9EA}",name:"\u6C34\u8CEA\u30C1\u30A7\u30C3\u30AF"},
{id:"trimming",icon:"\u2702\uFE0F",name:"\u30C8\u30EA\u30DF\u30F3\u30B0"},
{id:"addlife",icon:"\u{1F195}",name:"\u751F\u4F53\u8FFD\u52A0"},
{id:"death",icon:"\u2B50",name:"\u751F\u4F53\u2605"},
{id:"observation",icon:"\u{1F440}",name:"\u89B3\u5BDF"}
];

// ÊßãÈÄ†: tanks=„Ç∞„É´„Éº„Éó(Ê∞¥ÊßΩ), creatures=ÁÆ°ÁêÜÂØæË±°(Áîü‰Ωì), records=„Ç±„Ç¢Ë®òÈå≤(Áîü‰ΩìÂçò‰Ωç)
function defaultState(){return{schemaVersion:SCHEMA_VERSION,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),
data:{tanks:[],creatures:[],records:[],enabledCare:["feeding","waterchange"],customCare:[],customValues:[]},settings:{onboarded:false}}}

function migrate(raw){if(!raw)return defaultState();if(raw.schemaVersion===SCHEMA_VERSION&&raw.data)return raw;var base=defaultState();var d=raw.data||raw;
base.data={tanks:Array.isArray(d.tanks)?d.tanks:[],creatures:Array.isArray(d.creatures)?d.creatures:[],records:Array.isArray(d.records)?d.records:[],
enabledCare:Array.isArray(d.enabledCare)?d.enabledCare:["feeding","waterchange"],customCare:Array.isArray(d.customCare)?d.customCare:[],customValues:Array.isArray(d.customValues)?d.customValues:[]};
base.updatedAt=new Date().toISOString();return base}

var loadError=false,saveError=false,dbReady=false,pendingSave=false;

function openDB(){return new Promise(function(resolve,reject){var req=indexedDB.open(DB_NAME,DB_VERSION);req.onupgradeneeded=function(e){var db=e.target.result;if(!db.objectStoreNames.contains(DB_STORE)){db.createObjectStore(DB_STORE)}};req.onsuccess=function(e){resolve(e.target.result)};req.onerror=function(){reject(req.error)}})}
function idbLoad(){return openDB().then(function(db){return new Promise(function(resolve,reject){var tx=db.transaction(DB_STORE,"readonly");var store=tx.objectStore(DB_STORE);var req=store.get(STORAGE_KEY);req.onsuccess=function(){resolve(req.result||null)};req.onerror=function(){reject(req.error)}})})}
function idbSave(data){return openDB().then(function(db){return new Promise(function(resolve,reject){var tx=db.transaction(DB_STORE,"readwrite");var store=tx.objectStore(DB_STORE);var req=store.put(data,STORAGE_KEY);req.onsuccess=function(){resolve()};req.onerror=function(){reject(req.error)}})})}
function idbSize(){return openDB().then(function(db){return new Promise(function(resolve){var tx=db.transaction(DB_STORE,"readonly");var store=tx.objectStore(DB_STORE);var req=store.get(STORAGE_KEY);req.onsuccess=function(){var data=req.result;if(!data){resolve(0);return}resolve(new Blob([JSON.stringify(data)]).size)};req.onerror=function(){resolve(0)}})})}

function saveState(){ST.updatedAt=new Date().toISOString();if(!dbReady){pendingSave=true;return}idbSave(ST).then(function(){saveError=false}).catch(function(){saveError=true;toast("\u26A0\uFE0F \u4FDD\u5B58\u306B\u5931\u6557\u3057\u307E\u3057\u305F")})}

var ST=defaultState();var D=ST.data;

function initStorage(){return idbLoad().then(function(idbData){if(idbData){ST=migrate(idbData);D=ST.data;loadError=false}else{ST=defaultState();D=ST.data}}).catch(function(){ST=defaultState();D=ST.data;loadError=true}).then(function(){dbReady=true;if(pendingSave){pendingSave=false;saveState()}})}

function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,7)}
function fD(i){var d=new Date(i);return d.getFullYear()+"/"+(""+(d.getMonth()+1)).padStart(2,"0")+"/"+(""+(d.getDate())).padStart(2,"0")}
function fT(i){var d=new Date(i);return(""+d.getHours()).padStart(2,"0")+":"+(""+d.getMinutes()).padStart(2,"0")}
function toL(i){var d=new Date(i);return new Date(d.getTime()-d.getTimezoneOffset()*6e4).toISOString().slice(0,16)}
function ci(id){return PRESETS.find(function(t){return t.id===id})||D.customCare.find(function(t){return t.id===id})||null}
function ac(){return D.enabledCare.map(function(id){return PRESETS.find(function(p){return p.id===id})}).filter(Boolean).concat(D.customCare)}
function recItems(r){return Object.entries(r.careData||{}).filter(function(kv){return kv[1]}).map(function(kv){return ci(kv[0])}).filter(Boolean)}

function exportFile(){var blob=new Blob([JSON.stringify(ST)],{type:"application/json"});var url=URL.createObjectURL(blob);var a=document.createElement("a");a.href=url;a.download="temahima-aqua-backup-"+new Date().toISOString().slice(0,10)+".json";document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);toast("\u{1F4BE} \u30D0\u30C3\u30AF\u30A2\u30C3\u30D7\u3092\u4FDD\u5B58\u3057\u307E\u3057\u305F")}
function importFile(file,cb){var reader=new FileReader();reader.onload=function(){try{var raw=JSON.parse(String(reader.result||""));var st=migrate(raw);cb({ok:true,state:st,tC:(st.data.tanks||[]).length,rC:(st.data.records||[]).length,cC:(st.data.creatures||[]).length})}catch(e){cb({ok:false})}};reader.readAsText(file)}

function h(tag,a){var el=document.createElement(tag);var ch=Array.from(arguments).slice(2);if(a)Object.entries(a).forEach(function(kv){var k=kv[0],v=kv[1];if(k.startsWith("on"))el[k]=v;else if(k==="cls")el.className=v;else if(k==="html")el.innerHTML=v;else if(k==="stl"&&typeof v==="object")Object.assign(el.style,v);else el.setAttribute(k,v)});ch.flat(9).forEach(function(c){if(c==null||c===false)return;el.appendChild(typeof c==="string"||typeof c==="number"?document.createTextNode(""+c):c)});return el}

var tab="home",view=null,modal=null,expanded={},toastT=null,fCreature="all",fCare="all",fTank="all",scrollY=0;
function toast(m){var t=document.getElementById("toast");if(!t)return;t.textContent=m;t.style.display="block";t.style.animation="none";t.offsetWidth;t.style.animation="ta 2s forwards";if(toastT)clearTimeout(toastT);toastT=setTimeout(function(){t.style.display="none"},2100)}
function openModal(fn){modal=fn;R()}
function closeModal(){modal=null;R()}
function saveScroll(){var mn=document.querySelector(".mn");if(mn)scrollY=mn.scrollTop}
function restoreScroll(){var mn=document.querySelector(".mn");if(mn)mn.scrollTop=scrollY}

function viewName(){
  if(!view)return null;
  if(view.t==="creature"){var c=D.creatures.find(function(x){return x.id===view.id});return c?c.name:null}
  if(view.t==="tank"){var t=D.tanks.find(function(x){return x.id===view.id});return t?t.name:null}
  return null;
}

function R(){
  saveScroll();var app=document.getElementById("app");app.innerHTML="";
  app.appendChild(h("div",{id:"toast",cls:"toast",stl:{display:"none"}}));
  var hd=h("div",{cls:"hd"});
  if(view){var b=h("button",{cls:"back",onclick:function(){view=null;R()}});b.appendChild(h("span",null,"\u25C0 \u623B\u308B"));
    var vn=viewName();if(vn){b.appendChild(h("span",{cls:"loc"},"\uFF5C "+vn))}hd.appendChild(b);
  }else{var m=h("div",{cls:"hd-main",onclick:function(){tab="home";view=null;R()}});m.appendChild(h("span",{stl:{fontSize:"26px"}},"\u{1F420}"));m.appendChild(h("h1",null,"\u3066\u307E\u3072\u307E\u30A2\u30AF\u30A2"));hd.appendChild(m)}
  app.appendChild(hd);
  var mn=h("div",{cls:"mn"});
  if(view){if(view.t==="creature")mn.appendChild(renderCreature(view.id));else if(view.t==="tank")mn.appendChild(renderTankDetail(view.id))}
  else{if(tab==="home")mn.appendChild(renderHome());else if(tab==="records")mn.appendChild(renderRecords());else if(tab==="settings")mn.appendChild(renderSettings())}
  app.appendChild(mn);
  if(!view){var nv=h("nav",{cls:"nv"});
    [{id:"home",l:"\u{1F3E0}",t:"\u30DB\u30FC\u30E0"},{id:"records",l:"\u{1F4CB}",t:"\u30B1\u30A2\u5C65\u6B74"},{id:"settings",l:"\u2699\uFE0F",t:"\u8A2D\u5B9A"}].forEach(function(x){
      var bt=h("button",{cls:tab===x.id?"on":"",onclick:function(){tab=x.id;R()}});bt.appendChild(h("span",{stl:{fontSize:"20px"}},x.l));bt.appendChild(h("span",{stl:{fontSize:"11px",marginTop:"2px"}},x.t));nv.appendChild(bt)});app.appendChild(nv)}
  if(modal){var ov=h("div",{cls:"ov",onclick:function(e){if(e.target===ov)closeModal()}});var md=h("div",{cls:"md"});md.appendChild(h("button",{cls:"mx",onclick:closeModal},"\u2715"));md.appendChild(modal());ov.appendChild(md);app.appendChild(ov)}
  if(!ST.settings.onboarded&&!view&&!modal){renderOnboarding()}
  if(loadError&&!view&&!modal){toast("\u26A0\uFE0F \u30C7\u30FC\u30BF\u306E\u8AAD\u307F\u8FBC\u307F\u306B\u554F\u984C\u304C\u3042\u308A\u307E\u3057\u305F");loadError=false}
  restoreScroll();
}

function renderOnboarding(){
  var steps=[{icon:"\u{1F420}",title:"\u3088\u3046\u3053\u305D\uFF01",desc:"\u3053\u306E\u30A2\u30D7\u30EA\u306F\u304A\u4F7F\u3044\u306E\u7AEF\u672B\u5185\u306B\u30C7\u30FC\u30BF\u3092\u4FDD\u5B58\u3057\u307E\u3059\u3002\u30AF\u30E9\u30A6\u30C9\u306B\u306F\u9001\u4FE1\u3055\u308C\u306A\u3044\u306E\u3067\u5B89\u5FC3\u3067\u3059\u3002"},
  {icon:"\u{1F4F1}",title:"\u30DB\u30FC\u30E0\u753B\u9762\u306B\u8FFD\u52A0",desc:"Safari\u3067\u958B\u3044\u3066\u300C\u5171\u6709\u300D\u2192\u300C\u30DB\u30FC\u30E0\u753B\u9762\u306B\u8FFD\u52A0\u300D\u3067\u30A2\u30D7\u30EA\u306E\u3088\u3046\u306B\u4F7F\u3048\u307E\u3059\u3002"},
  {icon:"\u{1F4BE}",title:"\u30D0\u30C3\u30AF\u30A2\u30C3\u30D7\u3092\u5FD8\u308C\u305A\u306B",desc:"\u6A5F\u7A2E\u5909\u66F4\u3084\u30C7\u30FC\u30BF\u524A\u9664\u306B\u5099\u3048\u3066\u3001\u8A2D\u5B9A\u753B\u9762\u304B\u3089\u5B9A\u671F\u7684\u306B\u30D0\u30C3\u30AF\u30A2\u30C3\u30D7\u3092\u53D6\u308A\u307E\u3057\u3087\u3046\u3002"}];
  var step=0;
  function draw(){var w=document.getElementById("onboarding");if(w)w.remove();w=h("div",{id:"onboarding",cls:"ob-wrap"});var card=h("div",{cls:"ob-card"});var s=steps[step];
    card.appendChild(h("div",{cls:"ob-icon"},s.icon));card.appendChild(h("div",{cls:"ob-title"},s.title));card.appendChild(h("div",{cls:"ob-desc"},s.desc));
    var dots=h("div",{cls:"ob-dots"});for(var i=0;i<steps.length;i++){dots.appendChild(h("div",{cls:"ob-dot"+(i===step?" on":"")}))}card.appendChild(dots);
    var isLast=step===steps.length-1;card.appendChild(h("button",{cls:"ob-next",onclick:function(){if(isLast){ST.settings.onboarded=true;saveState();w.remove();R()}else{step++;draw()}}},isLast?"\u306F\u3058\u3081\u308B":"\u6B21\u3078"));
    w.appendChild(card);document.getElementById("app").appendChild(w)}
  draw();
}

// === HOME ===
function renderHome(){
  var el=h("div",{cls:"ct"});
  // Ê∞¥ÊßΩ„Åî„Å®„Å´Áîü‰Ωì„ÇíË°®Á§∫
  D.tanks.forEach(function(tank){
    var crs=D.creatures.filter(function(c){return c.tankId===tank.id});
    var op=expanded[tank.id]!==false;
    var cd=h("div",{cls:"cd"});
    var hdr=h("div",{cls:"cd-h",onclick:function(){expanded[tank.id]=!op;R()}});
    var lf=h("div",{cls:"rc"});lf.appendChild(h("span",{stl:{fontSize:"18px"}},op?"\u25BC":"\u25B6"));
    lf.appendChild(h("span",{cls:"gt"},tank.name));lf.appendChild(h("span",{cls:"cnt"},""+crs.length));hdr.appendChild(lf);
    var rb=h("div",{cls:"rc",onclick:function(e){e.stopPropagation()}});
    if(crs.length){rb.appendChild(h("button",{cls:"dbtn",onclick:function(){openCareForm(tank.id,true)}},"\u{1F4A7} \u307E\u3068\u3081\u3066"))}
    rb.appendChild(h("button",{stl:{fontSize:"12px",color:"#7a8e9e",padding:"4px 8px"},onclick:function(){view={t:"tank",id:tank.id};R()}},"\u2699\uFE0F"));
    hdr.appendChild(rb);cd.appendChild(hdr);
    if(op){var bd=h("div",{cls:"cd-b"});
      if(tank.memo){bd.appendChild(h("div",{cls:"muted",stl:{marginBottom:"8px",fontSize:"13px"}},tank.memo))}
      if(!crs.length)bd.appendChild(h("p",{cls:"muted"},"\u307E\u3060\u751F\u4F53\u304C\u3042\u308A\u307E\u305B\u3093"));
      crs.forEach(function(c){bd.appendChild(mkCC(c))});
      bd.appendChild(h("button",{cls:"ai",onclick:function(){openAddCreature(tank.id)}},"\uFF0B \u751F\u4F53\u3092\u8FFD\u52A0"));
      cd.appendChild(bd)}
    el.appendChild(cd)});
  // Ê∞¥ÊßΩ„Å™„Åó„ÅÆÁîü‰Ωì
  var ug=D.creatures.filter(function(c){return !c.tankId});
  if(ug.length){var cd=h("div",{cls:"cd"});var hdr=h("div",{cls:"cd-h"});var lf=h("div",{cls:"rc"});
    lf.appendChild(h("span",{stl:{fontSize:"18px"}},"\u{1F420}"));lf.appendChild(h("span",{cls:"gt"},"\u6C34\u69FD\u306A\u3057"));lf.appendChild(h("span",{cls:"cnt"},""+ug.length));
    hdr.appendChild(lf);cd.appendChild(hdr);var bd=h("div",{cls:"cd-b"});ug.forEach(function(c){bd.appendChild(mkCC(c))});cd.appendChild(bd);el.appendChild(cd)}
  // Á©∫Áä∂ÊÖã
  if(!D.creatures.length&&!D.tanks.length){var em=h("div",{cls:"empty"});em.appendChild(h("div",{stl:{fontSize:"64px",marginBottom:"16px"}},"\u{1F41F}"));
    em.appendChild(h("p",{stl:{fontSize:"17px",color:"#5a7088",lineHeight:"1.8"},html:"\u6C34\u69FD\u3092\u767B\u9332\u3057\u3066<br>\u30B1\u30A2\u3092\u59CB\u3081\u307E\u3057\u3087\u3046"}));el.appendChild(em)}
  var btns=h("div",{stl:{display:"flex",gap:"10px",marginTop:"16px",flexWrap:"wrap",alignItems:"center"}});
  btns.appendChild(h("button",{cls:"bg",onclick:function(){openAddTank()}},"\uFF0B \u6C34\u69FD\u3092\u8FFD\u52A0"));
  if(D.tanks.length){btns.appendChild(h("button",{cls:"bo",onclick:function(){openAddCreature()}},"\uFF0B \u751F\u4F53\u3092\u8FFD\u52A0"))}
  el.appendChild(btns);return el}

function mkCC(c){
  var last=D.records.filter(function(r){return r.creatureId===c.id}).sort(function(a,b){return new Date(b.timestamp)-new Date(a.timestamp)})[0];
  var btn=h("button",{cls:"pc",onclick:function(){view={t:"creature",id:c.id};R()}});var inner=h("div",{stl:{flex:"1"}});
  var nameRow=h("div",{stl:{display:"flex",alignItems:"center",gap:"8px"}});
  nameRow.appendChild(h("span",{cls:"pn"},c.name));
  if(c.count&&c.count>1)nameRow.appendChild(h("span",{stl:{fontSize:"13px",fontWeight:"800",color:"#2870a8",background:"#d0e4f5",borderRadius:"8px",padding:"1px 8px"}},"\u00D7"+c.count));
  inner.appendChild(nameRow);
  var meta=[];if(c.species)meta.push(c.species);
  if(meta.length){inner.appendChild(h("div",{cls:"bio-meta"},meta.join(" ")))}
  if(last){var sub=h("div",{cls:"ps"});sub.appendChild(h("span",null,fD(last.timestamp)));
    var items=recItems(last);if(items.length){sub.appendChild(h("span",null,items.map(function(i){return i.icon}).join("")))}
    inner.appendChild(sub)}
  else{inner.appendChild(h("div",{cls:"ps"},"\u30B1\u30A2\u5C65\u6B74\u306A\u3057"))}
  btn.appendChild(inner);btn.appendChild(h("span",{stl:{color:"#a0b0c0",fontSize:"18px"}},"\u25B6"));return btn}

// === ADD TANK ===
function openAddTank(){openModal(function(){var el=h("div");el.appendChild(h("h3",{cls:"mt"},"\u{1F41F} \u6C34\u69FD\u3092\u8FFD\u52A0"));
  var inp=h("input",{cls:"inp",placeholder:"\u6C34\u69FD\u306E\u540D\u524D\uFF08\u4F8B: 30cm\u6C34\u69FD\u3001\u30E1\u30C0\u30AB\u9262\uFF09"});el.appendChild(inp);setTimeout(function(){inp.focus()},100);
  el.appendChild(h("div",{cls:"sl",stl:{marginTop:"12px"}},"\u30E1\u30E2\uFF08\u4EFB\u610F\uFF09"));
  var ta=h("textarea",{cls:"ta",placeholder:"\u30B5\u30A4\u30BA\u3001\u30D5\u30A3\u30EB\u30BF\u30FC\u3001\u7ACB\u3061\u4E0A\u3052\u65E5\u306A\u3069",rows:"2"});el.appendChild(ta);
  el.appendChild(h("button",{cls:"bg",stl:{marginTop:"16px"},onclick:function(){var n=inp.value.trim();if(!n)return;var id=uid();D.tanks.push({id:id,name:n,memo:ta.value.trim()});expanded[id]=true;saveState();closeModal();toast("\u{1F41F} \u8FFD\u52A0\u3057\u307E\u3057\u305F")}},"\u8FFD\u52A0"));
  inp.onkeydown=function(e){if(e.key==="Enter")el.querySelector(".bg").click()};return el})}

// === ADD CREATURE ===
function openAddCreature(tankId){openModal(function(){var el=h("div");el.appendChild(h("h3",{cls:"mt"},"\u{1F420} \u751F\u4F53\u3092\u8FFD\u52A0"));
  // Ê∞¥ÊßΩÈÅ∏Êäû
  if(!tankId&&D.tanks.length>1){
    el.appendChild(h("div",{cls:"sl"},"\u6C34\u69FD"));
    var sel=h("select",{cls:"inp",id:"tank-sel"});
    D.tanks.forEach(function(t,i){var o=h("option",{value:t.id},t.name);if(i===0)o.selected=true;sel.appendChild(o)});el.appendChild(sel);
  }
  el.appendChild(h("div",{cls:"sl"},"\u540D\u524D"));
  var inp=h("input",{cls:"inp",placeholder:"\u4F8B: \u30E1\u30C0\u30AB\u3001\u30DF\u30CA\u30DF\u30CC\u30DE\u30A8\u30D3\u3001\u30A2\u30CC\u30D3\u30A2\u30B9"});el.appendChild(inp);setTimeout(function(){inp.focus()},100);
  el.appendChild(h("div",{cls:"sl",stl:{marginTop:"8px"}},"\u7A2E\u985E\uFF08\u4EFB\u610F\uFF09"));
  var sp=h("input",{cls:"inp",placeholder:"\u4F8B: \u30D2\u30E1\u30C0\u30AB\u3001\u30EC\u30C3\u30C9\u30D3\u30FC\u30B7\u30E5\u30EA\u30F3\u30D7"});el.appendChild(sp);
  el.appendChild(h("div",{cls:"sl",stl:{marginTop:"8px"}},"\u6570"));
  var cnt=h("input",{type:"number",cls:"inp",min:"0"});cnt.value="1";el.appendChild(cnt);
  el.appendChild(h("div",{cls:"sl",stl:{marginTop:"8px"}},"\u30E1\u30E2\uFF08\u4EFB\u610F\uFF09"));
  var ta=h("textarea",{cls:"ta",rows:"2",placeholder:"\u8CFC\u5165\u65E5\u3001\u8272\u306A\u3069"});el.appendChild(ta);
  var btns=h("div",{stl:{display:"flex",gap:"10px",marginTop:"16px"}});
  btns.appendChild(h("button",{cls:"bg",onclick:function(){var n=inp.value.trim();if(!n){toast("\u26A0\uFE0F \u540D\u524D\u3092\u5165\u529B");return}
    var tid=tankId||(document.getElementById("tank-sel")?document.getElementById("tank-sel").value:D.tanks.length?D.tanks[0].id:null);
    D.creatures.push({id:uid(),tankId:tid,name:n,species:sp.value.trim(),count:parseInt(cnt.value)||1,memo:ta.value.trim(),addedDate:new Date().toISOString()});saveState();closeModal();toast("\u{1F420} \u8FFD\u52A0\u3057\u307E\u3057\u305F");R()}},"\u8FFD\u52A0"));
  btns.appendChild(h("button",{cls:"bo",onclick:closeModal},"\u30AD\u30E3\u30F3\u30BB\u30EB"));el.appendChild(btns);return el})}

// === CREATURE DETAIL ===
function renderCreature(cid){
  var c=D.creatures.find(function(x){return x.id===cid});if(!c)return h("div",{cls:"ct"},h("p",{cls:"muted"},"\u898B\u3064\u304B\u308A\u307E\u305B\u3093"));
  var tank=D.tanks.find(function(x){return x.id===c.tankId});
  var recs=D.records.filter(function(r){return r.creatureId===cid}).sort(function(a,b){return new Date(b.timestamp)-new Date(a.timestamp)});
  var el=h("div",{cls:"ct"});
  var dh=h("div",{cls:"dh"});dh.appendChild(h("h2",{cls:"vt"},c.name));
  dh.appendChild(h("button",{cls:"ec",onclick:function(){openEditCreature(c)}},"\u7DE8\u96C6"));el.appendChild(dh);
  if(tank)el.appendChild(h("div",{cls:"gl"},"\u{1F41F} "+tank.name));
  var meta=[];if(c.species)meta.push(c.species);if(c.count&&c.count>1)meta.push("\u00D7"+c.count);
  if(meta.length)el.appendChild(h("div",{cls:"muted",stl:{marginBottom:"4px"}},meta.join(" \u30FB ")));
  if(c.memo)el.appendChild(h("div",{cls:"muted",stl:{marginBottom:"8px"}},c.memo));
  el.appendChild(h("div",{cls:"muted",stl:{marginBottom:"20px"}},"\u767B\u9332\u65E5: "+fD(c.addedDate)));
  var ar=h("div",{cls:"ar"});
  ar.appendChild(h("button",{cls:"ab",onclick:function(){openCareForm(cid,false)}},[h("span",{stl:{fontSize:"24px"}},"\u{1F4A7}"),h("span",null,"\u4ECA\u65E5\u306E\u30B1\u30A2")]));
  ar.appendChild(h("button",{cls:"ab",onclick:function(){openMoveView(c)}},[h("span",{stl:{fontSize:"24px"}},"\u{1F41F}"),h("span",null,"\u6C34\u69FD\u3092\u5909\u3048\u308B")]));
  ar.appendChild(h("button",{cls:"ab dg",onclick:function(){openConfirm("\u{1F5D1}\uFE0F \u524A\u9664\u306E\u78BA\u8A8D","\u300C"+c.name+"\u300D\u3068\u5168\u3066\u306E\u30B1\u30A2\u5C65\u6B74\u3092\u524A\u9664\u3057\u307E\u3059\u304B\uFF1F",function(){D.creatures=D.creatures.filter(function(x){return x.id!==cid});D.records=D.records.filter(function(x){return x.creatureId!==cid});saveState();closeModal();view=null;toast("\u{1F5D1}\uFE0F \u524A\u9664\u3057\u307E\u3057\u305F");R()})}},[h("span",{stl:{fontSize:"24px"}},"\u{1F5D1}\uFE0F"),h("span",{stl:{color:"#c55"}},"\u524A\u9664")]));
  el.appendChild(ar);
  el.appendChild(h("h3",{cls:"sl",stl:{marginTop:"24px"}},"\u30B1\u30A2\u5C65\u6B74"));
  if(!recs.length)el.appendChild(h("p",{cls:"muted"},"\u307E\u3060\u30B1\u30A2\u5C65\u6B74\u304C\u3042\u308A\u307E\u305B\u3093"));
  recs.forEach(function(r){
    var items=recItems(r);var row=h("button",{cls:"rr",onclick:function(){openEditRecord(r)}});
    var inner=h("div",{stl:{flex:"1"}});inner.appendChild(h("div",{stl:{fontSize:"13px",color:"#5a7088",fontWeight:"600"}},fD(r.timestamp)+" "+fT(r.timestamp)));
    if(items.length){var tags=h("div",{cls:"fw"});items.forEach(function(i){tags.appendChild(h("span",{cls:"tg"},i.icon+" "+i.name))});inner.appendChild(tags)}
    else if(!r.note||!r.note.trim()){inner.appendChild(h("div",{cls:"empty-care"},"\u2705 \u30B1\u30A2\u3057\u307E\u3057\u305F"))}
    if(r.values&&r.values.length){var vt=h("div",{cls:"fw",stl:{marginTop:"4px"}});r.values.forEach(function(v){vt.appendChild(h("span",{cls:"val-tag"},v.name+": "+v.value))});inner.appendChild(vt)}
    if(r.note&&r.note.trim())inner.appendChild(h("div",{cls:"rn"},"\u{1F4AC} "+r.note));
    row.appendChild(inner);row.appendChild(h("span",{stl:{color:"#a0b0c0"}},"\u25B6"));el.appendChild(row)});return el}

function openEditCreature(c){openModal(function(){var el=h("div");el.appendChild(h("h3",{cls:"mt"},"\u270F\uFE0F \u751F\u4F53\u3092\u7DE8\u96C6"));
  el.appendChild(h("div",{cls:"sl"},"\u540D\u524D"));var inp=h("input",{cls:"inp"});inp.value=c.name;el.appendChild(inp);
  el.appendChild(h("div",{cls:"sl",stl:{marginTop:"8px"}},"\u7A2E\u985E"));var sp=h("input",{cls:"inp"});sp.value=c.species||"";el.appendChild(sp);
  el.appendChild(h("div",{cls:"sl",stl:{marginTop:"8px"}},"\u6570"));var cnt=h("input",{type:"number",cls:"inp",min:"0"});cnt.value=""+(c.count||1);el.appendChild(cnt);
  el.appendChild(h("div",{cls:"sl",stl:{marginTop:"8px"}},"\u30E1\u30E2"));var ta=h("textarea",{cls:"ta",rows:"2"});ta.value=c.memo||"";el.appendChild(ta);
  var btns=h("div",{stl:{display:"flex",gap:"10px",marginTop:"16px"}});
  btns.appendChild(h("button",{cls:"bg",onclick:function(){var n=inp.value.trim();if(!n){toast("\u26A0\uFE0F \u540D\u524D\u3092\u5165\u529B");return}
    c.name=n;c.species=sp.value.trim();c.count=parseInt(cnt.value)||1;c.memo=ta.value.trim();saveState();closeModal();toast("\u270F\uFE0F \u66F4\u65B0\u3057\u307E\u3057\u305F");R()}},"\u4FDD\u5B58"));
  btns.appendChild(h("button",{cls:"bo",onclick:closeModal},"\u30AD\u30E3\u30F3\u30BB\u30EB"));el.appendChild(btns);return el})}

// === TANK DETAIL ===
function renderTankDetail(tid){
  var tank=D.tanks.find(function(x){return x.id===tid});if(!tank)return h("div",{cls:"ct"},h("p",{cls:"muted"},"\u898B\u3064\u304B\u308A\u307E\u305B\u3093"));
  var crs=D.creatures.filter(function(c){return c.tankId===tid});
  var el=h("div",{cls:"ct"});
  var dh=h("div",{cls:"dh"});dh.appendChild(h("h2",{cls:"vt"},"\u{1F41F} "+tank.name));
  dh.appendChild(h("button",{cls:"ec",onclick:function(){openEditName("\u540D\u524D\u3092\u5909\u3048\u308B",tank.name,function(n){tank.name=n;saveState();toast("\u270F\uFE0F \u5909\u66F4\u3057\u307E\u3057\u305F");R()})}},"\u540D\u524D\u3092\u5909\u3048\u308B"));el.appendChild(dh);
  if(tank.memo){el.appendChild(h("div",{cls:"muted",stl:{marginBottom:"12px"}},tank.memo));
    el.appendChild(h("button",{cls:"ch",stl:{marginBottom:"12px"},onclick:function(){openEditMemo(tank)}},"\u270F\uFE0F \u30E1\u30E2\u7DE8\u96C6"))}
  else{el.appendChild(h("button",{cls:"ch",stl:{marginBottom:"12px"},onclick:function(){openEditMemo(tank)}},"\uFF0B \u30E1\u30E2\u3092\u8FFD\u52A0"))}
  var tIdx=D.tanks.indexOf(tank);
  if(D.tanks.length>1){el.appendChild(h("div",{cls:"sl"},"\u6C34\u69FD\u306E\u4E26\u3073\u9806"));
    var ob2=h("div",{stl:{display:"flex",gap:"8px",marginBottom:"16px"}});
    if(tIdx>0)ob2.appendChild(h("button",{cls:"ch",onclick:function(){saveScroll();D.tanks.splice(tIdx,1);D.tanks.splice(tIdx-1,0,tank);saveState();R()}},"\u2191 \u4E0A\u3078"));
    if(tIdx<D.tanks.length-1)ob2.appendChild(h("button",{cls:"ch",onclick:function(){saveScroll();D.tanks.splice(tIdx,1);D.tanks.splice(tIdx+1,0,tank);saveState();R()}},"\u2193 \u4E0B\u3078"));el.appendChild(ob2)}
  el.appendChild(h("h3",{cls:"sl",stl:{marginTop:"8px"}},"\u751F\u4F53\u306E\u4E26\u3073\u9806 ("+crs.length+")"));
  if(!crs.length)el.appendChild(h("p",{cls:"muted"},"\u307E\u3060\u751F\u4F53\u304C\u3042\u308A\u307E\u305B\u3093"));
  crs.forEach(function(c,idx){var row=h("div",{cls:"sortrow"});
    row.appendChild(h("button",{stl:{flex:"1",textAlign:"left",fontWeight:"600",fontSize:"15px"},onclick:function(){view={t:"creature",id:c.id};R()}},c.name+(c.count>1?" \u00D7"+c.count:"")));
    var sb=h("div",{cls:"sortbtns"});
    if(idx>0)sb.appendChild(h("button",{cls:"ob",onclick:function(){saveScroll();var ci2=D.creatures.indexOf(c);var allC=D.creatures.filter(function(x){return x.tankId===tid});var prev=D.creatures.indexOf(allC[idx-1]);D.creatures.splice(ci2,1);D.creatures.splice(prev,0,c);saveState();R()}},"\u2191"));
    if(idx<crs.length-1)sb.appendChild(h("button",{cls:"ob",onclick:function(){saveScroll();var ci2=D.creatures.indexOf(c);var allC=D.creatures.filter(function(x){return x.tankId===tid});var nxt=D.creatures.indexOf(allC[idx+1]);D.creatures.splice(ci2,1);D.creatures.splice(nxt,0,c);saveState();R()}},"\u2193"));
    row.appendChild(sb);el.appendChild(row)});
  var ar=h("div",{cls:"ar",stl:{marginTop:"20px"}});
  ar.appendChild(h("button",{cls:"ab dg",onclick:function(){openConfirm("\u{1F5D1}\uFE0F \u524A\u9664\u306E\u78BA\u8A8D","\u6C34\u69FD\u3092\u524A\u9664\u3057\u307E\u3059\u304B\uFF1F\n\u751F\u4F53\u306F\u300C\u6C34\u69FD\u306A\u3057\u300D\u306B\u79FB\u52D5\u3057\u307E\u3059\u3002",function(){D.creatures.forEach(function(c){if(c.tankId===tid)c.tankId=null});D.tanks=D.tanks.filter(function(x){return x.id!==tid});saveState();closeModal();view=null;toast("\u{1F5D1}\uFE0F \u524A\u9664\u3057\u307E\u3057\u305F");R()})}},[h("span",{stl:{fontSize:"24px"}},"\u{1F5D1}\uFE0F"),h("span",{stl:{color:"#c55"}},"\u6C34\u69FD\u3092\u524A\u9664")]));
  el.appendChild(ar);return el}

function openEditMemo(tank){openModal(function(){var el=h("div");el.appendChild(h("h3",{cls:"mt"},"\u270F\uFE0F \u30E1\u30E2\u3092\u7DE8\u96C6"));
  var ta=h("textarea",{cls:"ta",rows:"4",placeholder:"\u30B5\u30A4\u30BA\u3001\u30D5\u30A3\u30EB\u30BF\u30FC\u3001\u7ACB\u3061\u4E0A\u3052\u65E5\u306A\u3069"});ta.value=tank.memo||"";el.appendChild(ta);setTimeout(function(){ta.focus()},100);
  el.appendChild(h("button",{cls:"bg",stl:{marginTop:"16px"},onclick:function(){tank.memo=ta.value.trim();saveState();closeModal();toast("\u270F\uFE0F \u66F4\u65B0\u3057\u307E\u3057\u305F");R()}},"\u4FDD\u5B58"));return el})}

function openEditName(title,cur,onSv){openModal(function(){var el=h("div");el.appendChild(h("h3",{cls:"mt"},title));
  var inp=h("input",{cls:"inp"});inp.value=cur;el.appendChild(inp);setTimeout(function(){inp.focus();inp.select()},100);
  el.appendChild(h("button",{cls:"bg",stl:{marginTop:"16px"},onclick:function(){var n=inp.value.trim();if(!n)return;onSv(n);closeModal()}},"\u4FDD\u5B58"));
  inp.onkeydown=function(e){if(e.key==="Enter")el.querySelector(".bg").click()};return el})}

function openConfirm(title,msg,onOk){openModal(function(){var el=h("div");el.appendChild(h("h3",{cls:"mt"},title));
  el.appendChild(h("p",{stl:{marginBottom:"16px",whiteSpace:"pre-line"}},msg));
  var btns=h("div",{stl:{display:"flex",gap:"10px"}});btns.appendChild(h("button",{cls:"bg",stl:{background:"#c55"},onclick:onOk},"\u524A\u9664\u3059\u308B"));
  btns.appendChild(h("button",{cls:"bo",onclick:closeModal},"\u30AD\u30E3\u30F3\u30BB\u30EB"));el.appendChild(btns);return el})}

// === MOVE ===
function openMoveView(c){openModal(function(){var el=h("div");el.appendChild(h("h3",{cls:"mt"},"\u{1F41F} \u6C34\u69FD\u3092\u5909\u3048\u308B"));
  el.appendChild(h("p",{cls:"muted",stl:{marginBottom:"12px"}},"\u300C"+c.name+"\u300D\u306E\u6C34\u69FD\u3092\u9078\u3093\u3067\u304F\u3060\u3055\u3044"));
  [{id:null,name:"\u6C34\u69FD\u306A\u3057"}].concat(D.tanks).forEach(function(o){var cur=c.tankId===o.id;
    var btn=h("button",{cls:"mb"+(cur?" cur":""),onclick:function(){if(cur)return;c.tankId=o.id;saveState();closeModal();toast("\u{1F41F} \u6C34\u69FD\u3092\u5909\u66F4\u3057\u307E\u3057\u305F");R()}});
    btn.appendChild(h("span",{stl:{fontWeight:cur?"700":"500"}},o.name));if(cur)btn.appendChild(h("span",{cls:"clbl"},"\u73FE\u5728"));el.appendChild(btn)});return el})}

// === CARE FORM ===
function buildValFields(el,existingVals){
  var valList=[];var valContainer=h("div");
  var valPresets=D.customValues.length?D.customValues:[{name:"\u6C34\u6E29",unit:"\u2103"},{name:"pH",unit:""}];
  function addRow(preset){
    var row=h("div",{cls:"val-row"});
    var ni=h("input",{cls:"inp",placeholder:"\u9805\u76EE\u540D",stl:{flex:"1",marginBottom:"0"}});if(preset&&preset.name)ni.value=preset.name;
    var vi=h("input",{type:"text",cls:"inp-sm",placeholder:"\u5024"});if(preset&&preset.value)vi.value=preset.value;
    var rm=h("button",{cls:"ob",stl:{color:"#c55"},onclick:function(){row.remove();var idx=valList.indexOf(entry);if(idx>-1)valList.splice(idx,1)}},"\u2715");
    row.appendChild(ni);row.appendChild(vi);row.appendChild(rm);valContainer.appendChild(row);
    var entry={nameEl:ni,valEl:vi};valList.push(entry)}
  if(existingVals&&existingVals.length){existingVals.forEach(function(v){addRow(v)})}
  else{valPresets.forEach(function(p){addRow({name:p.name,value:""})})}
  el.appendChild(valContainer);
  el.appendChild(h("button",{cls:"ch",stl:{marginBottom:"8px"},onclick:function(){addRow(null)}},"\uFF0B \u9805\u76EE\u3092\u8FFD\u52A0"));
  return{getVals:function(){return valList.map(function(e){return{name:e.nameEl.value.trim(),value:e.valEl.value.trim()}}).filter(function(v){return v.name&&v.value})},learnVals:function(vals){
    if(!vals.length)return;var existing=D.customValues.map(function(v){return v.name});vals.forEach(function(v){if(!existing.includes(v.name)){D.customValues.push({name:v.name,unit:""});existing.push(v.name)}})}}
}

function openCareForm(id,isTank){openModal(function(){var el=h("div");
  el.appendChild(h("h3",{cls:"mt"},isTank?"\u{1F4A7} \u307E\u3068\u3081\u3066\u30B1\u30A2":"\u{1F4A7} \u4ECA\u65E5\u306E\u30B1\u30A2"));
  if(isTank){var cnt=D.creatures.filter(function(c){return c.tankId===id}).length;el.appendChild(h("p",{cls:"muted",stl:{marginBottom:"12px"}},cnt+"\u3064\u306E\u751F\u4F53\u306B\u540C\u6642\u306B\u30B1\u30A2"))}
  var types=ac();var sel={};
  if(types.length){el.appendChild(h("div",{cls:"sl"},"\u30B1\u30A2\u5185\u5BB9"));
    var grid=h("div",{cls:"cg"});types.forEach(function(t){var btn=h("button",{cls:"cb",onclick:function(){sel[t.id]=!sel[t.id];btn.className="cb"+(sel[t.id]?" on":"")}});
    btn.appendChild(h("span",{stl:{fontSize:"24px"}},t.icon));btn.appendChild(h("span",{stl:{fontSize:"13px",fontWeight:"600"}},t.name));grid.appendChild(btn)});el.appendChild(grid)}
  el.appendChild(h("div",{cls:"sl",stl:{marginTop:"16px"}},"\u6570\u5024\u8A18\u9332\uFF08\u4EFB\u610F\uFF09"));
  var vf=buildValFields(el,null);
  el.appendChild(h("div",{cls:"sl",stl:{marginTop:"12px"}},"\u30E1\u30E2"));
  var ta=h("textarea",{cls:"ta",placeholder:"\u6C17\u3065\u3044\u305F\u3053\u3068\u306A\u3069",rows:"3"});el.appendChild(ta);
  var btns=h("div",{stl:{display:"flex",gap:"10px",marginTop:"20px"}});
  btns.appendChild(h("button",{cls:"bg",onclick:function(){var vals=vf.getVals();vf.learnVals(vals);
    if(isTank){var ts=new Date().toISOString();D.creatures.filter(function(c){return c.tankId===id}).forEach(function(c){D.records.push({id:uid(),creatureId:c.id,timestamp:ts,careData:Object.assign({},sel),values:vals.slice(),note:ta.value.trim()})});saveState();closeModal();toast("\u{1F4A7} \u307E\u3068\u3081\u3066\u30B1\u30A2\u5B8C\u4E86\uFF01");R()}
    else{D.records.push({id:uid(),creatureId:id,timestamp:new Date().toISOString(),careData:sel,values:vals,note:ta.value.trim()});saveState();closeModal();toast("\u{1F4A7} \u30B1\u30A2\u5B8C\u4E86\uFF01");R()}
  }},"\u4FDD\u5B58\u3059\u308B"));btns.appendChild(h("button",{cls:"bo",onclick:closeModal},"\u30AD\u30E3\u30F3\u30BB\u30EB"));el.appendChild(btns);return el})}

// === EDIT RECORD ===
function openEditRecord(rec){openModal(function(){var el=h("div");el.appendChild(h("h3",{cls:"mt"},"\u270F\uFE0F \u30B1\u30A2\u306E\u7DE8\u96C6"));
  el.appendChild(h("div",{cls:"sl"},"\u65E5\u6642"));var dti=h("input",{type:"datetime-local",cls:"inp"});dti.value=toL(rec.timestamp);el.appendChild(dti);
  var types=ac();var allT=types.slice();Object.keys(rec.careData||{}).forEach(function(k){if(!allT.find(function(t){return t.id===k})){var i=ci(k);if(i)allT.push(i)}});
  var sel=Object.assign({},rec.careData);
  el.appendChild(h("div",{cls:"sl",stl:{marginTop:"12px"}},"\u30B1\u30A2\u5185\u5BB9"));
  var grid=h("div",{cls:"cg"});allT.forEach(function(t){var btn=h("button",{cls:"cb"+(sel[t.id]?" on":""),onclick:function(){sel[t.id]=!sel[t.id];btn.className="cb"+(sel[t.id]?" on":"")}});
  btn.appendChild(h("span",{stl:{fontSize:"24px"}},t.icon));btn.appendChild(h("span",{stl:{fontSize:"13px",fontWeight:"600"}},t.name));grid.appendChild(btn)});el.appendChild(grid);
  el.appendChild(h("div",{cls:"sl",stl:{marginTop:"16px"}},"\u6570\u5024\u8A18\u9332"));
  var vf=buildValFields(el,rec.values);
  el.appendChild(h("div",{cls:"sl",stl:{marginTop:"12px"}},"\u30E1\u30E2"));var ta=h("textarea",{cls:"ta",rows:"3"});ta.value=rec.note||"";el.appendChild(ta);
  var btns=h("div",{stl:{display:"flex",gap:"10px",marginTop:"20px",flexWrap:"wrap"}});
  btns.appendChild(h("button",{cls:"bg",onclick:function(){var vals=vf.getVals();vf.learnVals(vals);
    rec.careData=sel;rec.values=vals;rec.note=ta.value.trim();rec.timestamp=new Date(dti.value).toISOString();saveState();closeModal();toast("\u270F\uFE0F \u66F4\u65B0\u3057\u307E\u3057\u305F");R()}},"\u4FDD\u5B58"));
  btns.appendChild(h("button",{cls:"bo dg",onclick:function(){D.records=D.records.filter(function(x){return x.id!==rec.id});saveState();closeModal();toast("\u{1F5D1}\uFE0F \u524A\u9664\u3057\u307E\u3057\u305F");R()}},"\u524A\u9664"));
  btns.appendChild(h("button",{cls:"bo",onclick:closeModal},"\u30AD\u30E3\u30F3\u30BB\u30EB"));el.appendChild(btns);return el})}

// === RECORDS ===
function renderRecords(){
  var el=h("div",{cls:"ct"});var all=D.records.slice().sort(function(a,b){return new Date(b.timestamp)-new Date(a.timestamp)});
  if(!all.length){var em=h("div",{cls:"empty"});em.appendChild(h("div",{stl:{fontSize:"56px"}},"\u{1F4CB}"));em.appendChild(h("p",{stl:{fontSize:"17px",color:"#5a7088",marginTop:"14px"}},"\u307E\u3060\u30B1\u30A2\u5C65\u6B74\u304C\u3042\u308A\u307E\u305B\u3093"));el.appendChild(em);return el}
  var fb=h("div",{cls:"fbar"});
  var s1=h("select",{cls:"sel",onchange:function(e){fTank=e.target.value;R()}});s1.appendChild(h("option",{value:"all"},"\u5168\u6C34\u69FD"));
  D.tanks.forEach(function(t){var o=h("option",{value:t.id},t.name);if(fTank===t.id)o.selected=true;s1.appendChild(o)});fb.appendChild(s1);
  var s2=h("select",{cls:"sel",onchange:function(e){fCreature=e.target.value;R()}});s2.appendChild(h("option",{value:"all"},"\u5168\u751F\u4F53"));
  D.creatures.forEach(function(c){var o=h("option",{value:c.id},c.name);if(fCreature===c.id)o.selected=true;s2.appendChild(o)});fb.appendChild(s2);
  var s3=h("select",{cls:"sel",onchange:function(e){fCare=e.target.value;R()}});s3.appendChild(h("option",{value:"all"},"\u5168\u30B1\u30A2"));
  ac().forEach(function(c){var o=h("option",{value:c.id},c.icon+" "+c.name);if(fCare===c.id)o.selected=true;s3.appendChild(o)});fb.appendChild(s3);el.appendChild(fb);
  var f=all;
  if(fTank!=="all")f=f.filter(function(r){var c=D.creatures.find(function(x){return x.id===r.creatureId});return c&&c.tankId===fTank});
  if(fCreature!=="all")f=f.filter(function(r){return r.creatureId===fCreature});
  if(fCare!=="all")f=f.filter(function(r){return r.careData&&r.careData[fCare]});
  if(!f.length){el.appendChild(h("p",{cls:"muted",stl:{textAlign:"center",padding:"30px 0"}},"\u8A72\u5F53\u3059\u308B\u30B1\u30A2\u5C65\u6B74\u304C\u3042\u308A\u307E\u305B\u3093"));return el}
  var byD={};f.forEach(function(r){var k=fD(r.timestamp);if(!byD[k])byD[k]=[];byD[k].push(r)});
  Object.entries(byD).forEach(function(kv){el.appendChild(h("div",{cls:"dthd"},"\u{1F4C5} "+kv[0]));
    kv[1].forEach(function(r){
      var cn=(D.creatures.find(function(c){return c.id===r.creatureId})||{}).name||"\uFF08\u524A\u9664\u6E08\u307F\uFF09";
      var items=recItems(r);var row=h("button",{cls:"rr",onclick:function(){openEditRecord(r)}});
      var inner=h("div",{stl:{flex:"1"}});
      var top=h("div",{stl:{display:"flex",justifyContent:"space-between",alignItems:"center"}});
      top.appendChild(h("span",{stl:{fontWeight:"700",fontSize:"15px"}},cn));top.appendChild(h("span",{stl:{fontSize:"13px",color:"#7a8e9e"}},"\u{1F550} "+fT(r.timestamp)));inner.appendChild(top);
      if(items.length){var tags=h("div",{stl:{display:"flex",flexWrap:"wrap",gap:"5px",marginTop:"6px"}});items.forEach(function(i){tags.appendChild(h("span",{cls:"tg"},i.icon+" "+i.name))});inner.appendChild(tags)}
      else if(!r.note||!r.note.trim()){inner.appendChild(h("div",{cls:"empty-care",stl:{marginTop:"6px"}},"\u2705 \u30B1\u30A2\u3057\u307E\u3057\u305F"))}
      if(r.values&&r.values.length){var vt=h("div",{cls:"fw",stl:{marginTop:"4px"}});r.values.forEach(function(v){vt.appendChild(h("span",{cls:"val-tag"},v.name+": "+v.value))});inner.appendChild(vt)}
      if(r.note&&r.note.trim())inner.appendChild(h("div",{cls:"rn"},"\u{1F4AC} "+r.note));
      row.appendChild(inner);row.appendChild(h("span",{stl:{color:"#a0b0c0"}},"\u25B6"));el.appendChild(row)})});return el}

// === SETTINGS ===
function renderSettings(){
  var el=h("div",{cls:"ct"});
  var s1=h("div",{cls:"sc"});s1.appendChild(h("h3",{cls:"st"},"\u4F7F\u7528\u3059\u308B\u30B1\u30A2\u9805\u76EE"));s1.appendChild(h("p",{cls:"sd"},"ON\u306B\u3057\u305F\u9805\u76EE\u304C\u30B1\u30A2\u753B\u9762\u306B\u8868\u793A\u3055\u308C\u307E\u3059"));
  PRESETS.forEach(function(ct){var row=h("div",{cls:"tr"});var lf=h("div",{cls:"rc"});lf.appendChild(h("span",{stl:{fontSize:"22px"}},ct.icon));lf.appendChild(h("span",{cls:"tl"},ct.name));row.appendChild(lf);
    var isOn=D.enabledCare.includes(ct.id);var tog=h("div",{cls:"tg2"+(isOn?" on":""),onclick:function(){if(isOn)D.enabledCare=D.enabledCare.filter(function(x){return x!==ct.id});else D.enabledCare.push(ct.id);saveState();R()}});
    tog.appendChild(h("div",{cls:"kn"}));row.appendChild(tog);s1.appendChild(row)});el.appendChild(s1);

  var s2=h("div",{cls:"sc"});s2.appendChild(h("h3",{cls:"st"},"\u30AA\u30EA\u30B8\u30CA\u30EB\u9805\u76EE"));
  if(!D.customCare.length)s2.appendChild(h("p",{cls:"sd"},"\u72EC\u81EA\u306E\u30B1\u30A2\u9805\u76EE\u3092\u8FFD\u52A0\u3067\u304D\u307E\u3059"));
  D.customCare.forEach(function(ct,idx){var row=h("div",{cls:"tr"});var lf=h("div",{cls:"rc",stl:{flex:"1"}});
    lf.appendChild(h("span",{stl:{fontSize:"22px"}},ct.icon));lf.appendChild(h("span",{cls:"tl"},ct.name));row.appendChild(lf);
    var obs=h("div",{stl:{display:"flex",gap:"4px",alignItems:"center"}});
    if(idx>0)obs.appendChild(h("button",{cls:"ob",onclick:function(){saveScroll();D.customCare.splice(idx,1);D.customCare.splice(idx-1,0,ct);saveState();R()}},"\u2191"));
    if(idx<D.customCare.length-1)obs.appendChild(h("button",{cls:"ob",onclick:function(){saveScroll();D.customCare.splice(idx,1);D.customCare.splice(idx+1,0,ct);saveState();R()}},"\u2193"));
    obs.appendChild(h("button",{cls:"ch",onclick:function(){openEditCustom(ct)}},"\u270F\uFE0F"));
    obs.appendChild(h("button",{cls:"ch dg",onclick:function(){openConfirm("\u{1F5D1}\uFE0F \u524A\u9664\u306E\u78BA\u8A8D","\u300C"+ct.name+"\u300D\u3092\u524A\u9664\u3057\u307E\u3059\u304B\uFF1F",function(){D.customCare=D.customCare.filter(function(t){return t.id!==ct.id});D.records.forEach(function(r){delete r.careData[ct.id]});saveState();closeModal();toast("\u{1F5D1}\uFE0F \u524A\u9664\u3057\u307E\u3057\u305F");R()})}},"\u{1F5D1}\uFE0F"));
    row.appendChild(obs);s2.appendChild(row)});
  s2.appendChild(h("button",{cls:"ai",onclick:openAddCustom},"\uFF0B \u30AA\u30EA\u30B8\u30CA\u30EB\u9805\u76EE\u3092\u8FFD\u52A0"));el.appendChild(s2);

  var s3=h("div",{cls:"sc"});s3.appendChild(h("h3",{cls:"st"},"\u30B1\u30A2\u9805\u76EE\u306E\u8868\u793A\u9806"));s3.appendChild(h("p",{cls:"sd"},"\u30D7\u30EA\u30BB\u30C3\u30C8\uFF08ON\uFF09\u2192 \u30AA\u30EA\u30B8\u30CA\u30EB\u306E\u9806\u3067\u8868\u793A"));
  var ep=D.enabledCare.map(function(id){return PRESETS.find(function(p){return p.id===id})}).filter(Boolean);
  ep.forEach(function(ct,idx){var row=h("div",{cls:"tr"});var lf=h("div",{cls:"rc",stl:{flex:"1"}});lf.appendChild(h("span",{stl:{fontSize:"22px"}},ct.icon));lf.appendChild(h("span",{cls:"tl"},ct.name));row.appendChild(lf);
    var obs=h("div",{stl:{display:"flex",gap:"4px"}});
    if(idx>0)obs.appendChild(h("button",{cls:"ob",onclick:function(){saveScroll();var tmp=D.enabledCare[idx];D.enabledCare[idx]=D.enabledCare[idx-1];D.enabledCare[idx-1]=tmp;saveState();R()}},"\u2191"));
    if(idx<ep.length-1)obs.appendChild(h("button",{cls:"ob",onclick:function(){saveScroll();var tmp=D.enabledCare[idx];D.enabledCare[idx]=D.enabledCare[idx+1];D.enabledCare[idx+1]=tmp;saveState();R()}},"\u2193"));
    row.appendChild(obs);s3.appendChild(row)});
  if(!ep.length)s3.appendChild(h("p",{cls:"muted"},"\u6709\u52B9\u306A\u9805\u76EE\u304C\u3042\u308A\u307E\u305B\u3093"));el.appendChild(s3);

  // „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó
  var s4=h("div",{cls:"sc"});s4.appendChild(h("h3",{cls:"st"},"\u{1F4BE} \u30C7\u30FC\u30BF\u306E\u30D0\u30C3\u30AF\u30A2\u30C3\u30D7"));
  var ex1=h("div",{cls:"bk-step"});ex1.appendChild(h("div",{cls:"bk-num"},"1"));var ext1=h("div",{cls:"bk-txt"});
  ext1.appendChild(h("div",{stl:{fontWeight:"700",marginBottom:"6px"}},"\u30D5\u30A1\u30A4\u30EB\u306B\u4FDD\u5B58\u3059\u308B"));
  ext1.appendChild(h("div",{stl:{fontSize:"13px",color:"#6b7f8e",marginBottom:"10px"}},"\u30D0\u30C3\u30AF\u30A2\u30C3\u30D7\u30D5\u30A1\u30A4\u30EB\uFF08JSON\uFF09\u3092\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u3002"));
  ext1.appendChild(h("button",{cls:"bgs",onclick:exportFile},"\u{1F4BE} \u30D5\u30A1\u30A4\u30EB\u306B\u4FDD\u5B58"));ex1.appendChild(ext1);s4.appendChild(ex1);
  var im1=h("div",{cls:"bk-step"});im1.appendChild(h("div",{cls:"bk-num"},"2"));var imt1=h("div",{cls:"bk-txt"});
  imt1.appendChild(h("div",{stl:{fontWeight:"700",marginBottom:"6px"}},"\u30D5\u30A1\u30A4\u30EB\u304B\u3089\u5FA9\u5143\u3059\u308B"));
  imt1.appendChild(h("div",{stl:{fontSize:"13px",color:"#6b7f8e",marginBottom:"10px"}},"\u4FDD\u5B58\u3057\u305FJSON\u30D5\u30A1\u30A4\u30EB\u3092\u9078\u629E\u3057\u3066\u5FA9\u5143\u3002"));
  var fi=h("input",{type:"file",accept:".json",cls:"file-hidden",id:"import-file",onchange:function(e){var file=e.target.files&&e.target.files[0];if(!file)return;
    importFile(file,function(r){if(!r.ok){toast("\u274C \u30D5\u30A1\u30A4\u30EB\u306E\u5F62\u5F0F\u304C\u6B63\u3057\u304F\u3042\u308A\u307E\u305B\u3093");return}
      openModal(function(){var el=h("div");el.appendChild(h("h3",{cls:"mt"},"\u{1F4C2} \u5FA9\u5143\u306E\u78BA\u8A8D"));
        el.appendChild(h("p",{stl:{marginBottom:"16px",lineHeight:"1.8",whiteSpace:"pre-line"}},"\u4EE5\u4E0B\u306E\u30C7\u30FC\u30BF\u3092\u5FA9\u5143\u3057\u307E\u3059\u304B\uFF1F\n\u6C34\u69FD: "+r.tC+"\u4EF6\n\u751F\u4F53: "+r.cC+"\u4EF6\n\u30B1\u30A2\u5C65\u6B74: "+r.rC+"\u4EF6\n\n\u203B \u73FE\u5728\u306E\u30C7\u30FC\u30BF\u306F\u4E0A\u66F8\u304D\u3055\u308C\u307E\u3059"));
        var btns=h("div",{stl:{display:"flex",gap:"10px"}});btns.appendChild(h("button",{cls:"bg",onclick:function(){ST=r.state;D=ST.data;idbSave(ST).then(function(){saveError=false;closeModal();toast("\u2705 \u5FA9\u5143\u3057\u307E\u3057\u305F\uFF01");R()}).catch(function(){saveError=true;closeModal();toast("\u26A0\uFE0F \u5FA9\u5143\u306B\u5931\u6557\u3057\u307E\u3057\u305F");R()})}},"\u5FA9\u5143\u3059\u308B"));
        btns.appendChild(h("button",{cls:"bo",onclick:closeModal},"\u30AD\u30E3\u30F3\u30BB\u30EB"));el.appendChild(btns);return el})})}});
  imt1.appendChild(fi);imt1.appendChild(h("button",{cls:"bgs",onclick:function(){document.getElementById("import-file").click()}},"\u{1F4C2} \u30D5\u30A1\u30A4\u30EB\u3092\u9078\u629E"));im1.appendChild(imt1);s4.appendChild(im1);
  var ex2=h("div",{cls:"bk-step"});ex2.appendChild(h("div",{cls:"bk-num",stl:{background:"#7a8e9e"}},"?"));var ext2=h("div",{cls:"bk-txt"});
  ext2.appendChild(h("div",{stl:{fontWeight:"700",marginBottom:"6px"}},"\u30AF\u30EA\u30C3\u30D7\u30DC\u30FC\u30C9\u3067\u30B3\u30D4\u30FC"));
  ext2.appendChild(h("button",{cls:"bos",onclick:function(){var j=JSON.stringify(ST);if(navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(j).then(function(){toast("\u{1F4CB} \u30B3\u30D4\u30FC\u3057\u307E\u3057\u305F")}).catch(function(){fbCopy(j)});else fbCopy(j)}},"\u{1F4CB} \u30B3\u30D4\u30FC"));ex2.appendChild(ext2);s4.appendChild(ex2);
  var rs=h("div",{cls:"bk-step",stl:{borderColor:"#e8c0c0"}});rs.appendChild(h("div",{cls:"bk-num",stl:{background:"#c55"}},"!"));var rst=h("div",{cls:"bk-txt"});
  rst.appendChild(h("div",{stl:{fontWeight:"700",marginBottom:"6px",color:"#c55"}},"\u5168\u30C7\u30FC\u30BF\u3092\u30EA\u30BB\u30C3\u30C8"));
  rst.appendChild(h("button",{cls:"ch dg",onclick:function(){openConfirm("\u26A0\uFE0F \u5168\u30C7\u30FC\u30BF\u30EA\u30BB\u30C3\u30C8","\u672C\u5F53\u306B\u3059\u3079\u3066\u306E\u30C7\u30FC\u30BF\u3092\u524A\u9664\u3057\u307E\u3059\u304B\uFF1F\n\u3053\u306E\u64CD\u4F5C\u306F\u53D6\u308A\u6D88\u305B\u307E\u305B\u3093\u3002",function(){ST=defaultState();ST.settings.onboarded=true;D=ST.data;idbSave(ST).then(function(){closeModal();toast("\u{1F5D1}\uFE0F \u30EA\u30BB\u30C3\u30C8\u3057\u307E\u3057\u305F");R()}).catch(function(){closeModal();toast("\u26A0\uFE0F \u5931\u6557\u3057\u307E\u3057\u305F");R()})})}},"\u{1F5D1}\uFE0F \u30EA\u30BB\u30C3\u30C8\u3059\u308B"));rs.appendChild(rst);s4.appendChild(rs);el.appendChild(s4);

  // „É™„É≥„ÇØ
  var s5=h("div",{cls:"sc"});s5.appendChild(h("h3",{cls:"st"},"\u{1F517} \u30EA\u30F3\u30AF"));
  var lk1=h("button",{cls:"tr",stl:{cursor:"pointer",width:"100%"},onclick:function(){window.open("privacy-policy.html","_blank")}});
  lk1.appendChild(h("span",{cls:"tl"},"\u{1F4C4} \u30D7\u30E9\u30A4\u30D0\u30B7\u30FC\u30DD\u30EA\u30B7\u30FC"));lk1.appendChild(h("span",{stl:{color:"#a0b0c0"}},"\u25B6"));s5.appendChild(lk1);
  var lk2=h("button",{cls:"tr",stl:{cursor:"pointer",width:"100%"},onclick:function(){window.open("https://note.com/stillnova_studio","_blank")}});
  lk2.appendChild(h("span",{cls:"tl"},"\u{1F4DD} \u958B\u767A\u8005\u30CE\u30FC\u30C8"));lk2.appendChild(h("span",{stl:{color:"#a0b0c0"}},"\u25B6"));s5.appendChild(lk2);el.appendChild(s5);

  // Ë®∫Êñ≠
  var s6=h("div",{cls:"sc"});s6.appendChild(h("h3",{cls:"st"},"\u{1F529} \u8A3A\u65AD\u60C5\u5831"));
  var diag=h("div",{cls:"diag"});var idbOk=true;try{indexedDB.open("__test__")}catch(e){idbOk=false}
  var sizeEl=h("span",{cls:"diag-v"},"\u8A08\u7B97\u4E2D...");
  idbSize().then(function(bytes){var kb=(bytes/1024).toFixed(1);sizeEl.textContent=kb+"KB"}).catch(function(){sizeEl.textContent="-"});
  [["\u30A2\u30D7\u30EA",APP_VERSION],["\u4FDD\u5B58","IndexedDB"],["\u6C34\u69FD",""+D.tanks.length],["\u751F\u4F53",""+D.creatures.length],["\u30B1\u30A2\u5C65\u6B74",""+D.records.length],["\u66F4\u65B0",ST.updatedAt?fD(ST.updatedAt)+" "+fT(ST.updatedAt):"-"],["IndexedDB",idbOk?"\u2705":"\u274C"],["\u4FDD\u5B58",saveError?"\u274C":"\u2705"]].forEach(function(r){var dr=h("div",{cls:"diag-row"});dr.appendChild(h("span",{cls:"diag-k"},r[0]));dr.appendChild(h("span",{cls:"diag-v"},r[1]));diag.appendChild(dr)});
  var sizeRow=h("div",{cls:"diag-row"});sizeRow.appendChild(h("span",{cls:"diag-k"},"\u5BB9\u91CF"));sizeRow.appendChild(sizeEl);diag.appendChild(sizeRow);
  s6.appendChild(diag);el.appendChild(s6);return el}

function fbCopy(text){openModal(function(){var el=h("div");el.appendChild(h("h3",{cls:"mt"},"\u{1F4CB} \u30B3\u30D4\u30FC"));
  var ta=h("textarea",{cls:"ta",rows:"5",readonly:"true"});ta.value=text;ta.onclick=function(){ta.select()};el.appendChild(ta);return el})}

function openAddCustom(){openModal(function(){var el=h("div");el.appendChild(h("h3",{cls:"mt"},"\u2728 \u30AA\u30EA\u30B8\u30CA\u30EB\u9805\u76EE\u3092\u8FFD\u52A0"));
  el.appendChild(h("div",{cls:"sl"},"\u30A2\u30A4\u30B3\u30F3"));var emi=h("input",{cls:"emi",maxlength:"2"});emi.value="\u{1F30A}";el.appendChild(emi);
  el.appendChild(h("div",{cls:"sl",stl:{marginTop:"12px"}},"\u9805\u76EE\u540D"));var nmi=h("input",{cls:"inp",placeholder:"\u4F8B: \u30A8\u30A2\u30EC\u30FC\u30B7\u30E7\u30F3\u78BA\u8A8D"});el.appendChild(nmi);setTimeout(function(){nmi.focus()},100);
  var btns=h("div",{stl:{display:"flex",gap:"10px",marginTop:"20px"}});
  btns.appendChild(h("button",{cls:"bg",onclick:function(){var name=nmi.value.trim();if(!name){toast("\u26A0\uFE0F \u9805\u76EE\u540D\u3092\u5165\u529B");return}
    D.customCare.push({id:"c_"+uid(),icon:emi.value||"\u{1F30A}",name:name,isCustom:true});saveState();closeModal();toast("\u2705 \u8FFD\u52A0\u3057\u307E\u3057\u305F");R()}},"\u8FFD\u52A0"));
  btns.appendChild(h("button",{cls:"bo",onclick:closeModal},"\u30AD\u30E3\u30F3\u30BB\u30EB"));el.appendChild(btns);nmi.onkeydown=function(e){if(e.key==="Enter")btns.firstChild.click()};return el})}

function openEditCustom(ct){openModal(function(){var el=h("div");el.appendChild(h("h3",{cls:"mt"},"\u270F\uFE0F \u9805\u76EE\u3092\u7DE8\u96C6"));
  el.appendChild(h("div",{cls:"sl"},"\u30A2\u30A4\u30B3\u30F3"));var emi=h("input",{cls:"emi"});emi.value=ct.icon;el.appendChild(emi);
  el.appendChild(h("div",{cls:"sl",stl:{marginTop:"12px"}},"\u9805\u76EE\u540D"));var nmi=h("input",{cls:"inp"});nmi.value=ct.name;el.appendChild(nmi);setTimeout(function(){nmi.focus()},100);
  var btns=h("div",{stl:{display:"flex",gap:"10px",marginTop:"20px"}});
  btns.appendChild(h("button",{cls:"bg",onclick:function(){var name=nmi.value.trim();if(!name){toast("\u26A0\uFE0F \u9805\u76EE\u540D\u3092\u5165\u529B");return}
    ct.icon=emi.value||"\u{1F30A}";ct.name=name;saveState();closeModal();toast("\u270F\uFE0F \u66F4\u65B0\u3057\u307E\u3057\u305F");R()}},"\u4FDD\u5B58"));
  btns.appendChild(h("button",{cls:"bo",onclick:closeModal},"\u30AD\u30E3\u30F3\u30BB\u30EB"));el.appendChild(btns);return el})}

initStorage().then(function(){R()}).catch(function(){R()});
</script>
</body>
</html>
